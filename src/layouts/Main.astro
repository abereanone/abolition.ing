---
import NavBar from "@/components/NavBar.astro";
import Footer from "@/components/Footer.astro";
import { siteSettings } from "@/config/siteSettings";

const branding = siteSettings.branding;
const {
  title = branding.siteName,
  description = branding.description,
} = Astro.props;
const analyticsId = siteSettings.integrations.googleAnalyticsId;

const duplicateReport =
  (
    globalThis as typeof globalThis & {
      __QUESTION_DUPLICATE_REPORT__?: {
        heading: string;
        entries: Array<{ label: string; value: string; sources: string[] }>;
      };
    }
  ).__QUESTION_DUPLICATE_REPORT__ ?? null;

const duplicateReportPayload = duplicateReport ? JSON.stringify(duplicateReport) : null;
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="stylesheet" href="/styles/theme.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Playfair+Display:wght@600&display=swap"
      rel="stylesheet"
    />

    <!-- Google tag (gtag.js) -->
    {analyticsId ? (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${analyticsId}`}></script>
        <script
          is:inline
          data-analytics-id={analyticsId}
        >
          {`(() => {
            const script = document.currentScript;
            const id = script?.dataset.analyticsId;
            if (!id) {
              return;
            }
            window.dataLayer = window.dataLayer || [];
            function gtag(){window.dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', id);
          })();`}
        </script>
      </>
    ) : null}

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
  </head>

  <body>
    <NavBar />
    <main>
      <slot /> <!-- Your page-specific content -->
    </main>
    <Footer />

    {duplicateReportPayload ? (
      <script
        is:inline
        data-duplicate-report={duplicateReportPayload}
      >
        (function () {
          const script = document.currentScript;
          if (!script) {
            return;
          }

          let report;
          try {
            report = JSON.parse(script.dataset.duplicateReport || "");
          } catch (error) {
            console.error("Duplicate question metadata: unable to parse payload", error);
            return;
          }

          if (!report || !Array.isArray(report.entries) || report.entries.length === 0) {
            return;
          }

          console.groupCollapsed(report.heading || "Duplicate question metadata detected");
          for (const entry of report.entries) {
            const intro = `${entry.label} "${entry.value}" appears in:`;
            console.warn(intro);
            if (Array.isArray(entry.sources)) {
              for (const source of entry.sources) {
                console.warn(`  - ${source}`);
              }
            }
          }
          console.groupEnd();
        })();
      </script>
    ) : null}
  </body>
</html>
