---
import Main from "@/layouts/Main.astro";
import {
  findQuestion,
  getPublishedQuestions,
  getQuestionCategories,
  getRelatedQuestions,
  getQuestionAuthor,
  findAuthor,
} from "@/lib/questions";
import BibleReferencesScript from "@/components/BibleReferencesScript.astro";
import InlineSearchBox from "@/components/InlineSearchBox.astro";
import { siteSettings } from "@/config/siteSettings";

export function getStaticPaths() {
  return getPublishedQuestions().flatMap((question) => {
    const entries = [{ params: { slugOrId: question.slug } }];
    if (typeof question.id === "number") {
      entries.push({ params: { slugOrId: String(question.id) } });
    }
    return entries;
  });
}

const { slugOrId } = Astro.params;

let question = slugOrId ? findQuestion(slugOrId) : null;

if (!question && slugOrId) {
  const maybeId = Number(slugOrId);
  if (!Number.isNaN(maybeId)) {
    question = getPublishedQuestions().find((entry) => entry.id === maybeId) ?? null;
  }
}

if (!question) {
  throw new Error(`Question not found for identifier "${slugOrId}".`);
}

const questionSlug = question.slug;
const useIdLinks = typeof question.id === "number" && slugOrId === String(question.id);

const buildQuestionHref = (target: typeof question | null) => {
  if (!target) return "#";
  if (useIdLinks && typeof target.id === "number") {
    return `/questions/${target.id}`;
  }
  return `/questions/${target.slug}`;
};

const questionCategories = getQuestionCategories(question);
const author = getQuestionAuthor(question);
const showAuthors = siteSettings.showAuthor;
const showAuthorCard = showAuthors && !question.suppressAuthor && author;
const allPublishedQuestions = getPublishedQuestions();
const currentIndex = allPublishedQuestions.findIndex((entry) => entry.slug === question.slug);
const fallbackIndex = currentIndex + 1;
const questionNumber =
  typeof question.id === "number"
    ? question.id
    : fallbackIndex > 0
      ? fallbackIndex
      : null;
const siteName = siteSettings.branding.siteName;
const showQuestionId = siteSettings.showQuestionId && questionNumber !== null;
const previousQuestion = currentIndex > 0 ? allPublishedQuestions[currentIndex - 1] : null;
const nextQuestion =
  currentIndex >= 0 && currentIndex < allPublishedQuestions.length - 1
    ? allPublishedQuestions[currentIndex + 1]
    : null;

const markdownFiles = import.meta.glob("@/content/questions/*.md", { eager: true });
const markdownModules = Object.values(markdownFiles);
const findMarkdownModule = (fileName: string | undefined) =>
  fileName ? markdownModules.find((module) => module.file?.endsWith(fileName)) ?? null : null;

const page = findMarkdownModule(question.markdown);

const longPage = findMarkdownModule(`${questionSlug}-long.md`);
const longAuthor = question.longAuthorId ? findAuthor(question.longAuthorId) : null;
const showLongAuthor = showAuthors && !question.suppressAuthor && longAuthor;
const relatedQuestions = getRelatedQuestions(question);
---

<Main title={`${question.title} - ${siteName}`}>
  {previousQuestion || nextQuestion ? (
    <nav class="question-top-nav" aria-label="Question navigation">
      {previousQuestion ? (
        <a class="question-top-link prev" href={buildQuestionHref(previousQuestion)}>
          Prev
        </a>
      ) : (
        <span aria-hidden="true" class="question-top-link placeholder" />
      )}

      <a class="question-top-link random-link" href="/random">Random</a>
      <div class="question-top-search">
        <InlineSearchBox
          id={`question-search-${questionSlug}`}
          label="Search for another question"
          placeholder="Search other questions..."
        />
      </div>

      {nextQuestion ? (
        <a class="question-top-link next" href={buildQuestionHref(nextQuestion)}>
          Next
        </a>
      ) : (
        <span aria-hidden="true" class="question-top-link placeholder" />
      )}
    </nav>
  ) : (
    <InlineSearchBox
      id={`question-search-${questionSlug}`}
      label="Search for another question"
      placeholder="Search other questions..."
    />
  )}
  <article class="question-article card-panel">
    <section class="question-header">
      <h1 class="page-title">{question.title}</h1>
      {showQuestionId ? (
        <p class="question-meta">Question #{questionNumber}</p>
      ) : null}
    </section>

    <div class="question-body" data-bible-autolink>
      {page ? <page.Content /> : <p><em>Content not found.</em></p>}
    </div>

    {longPage ? (
      <div class="long-explanation" data-long-explanation>
        <button
          type="button"
          class="long-toggle"
          data-long-toggle
          aria-expanded="false"
        >
          Read the long explanation
        </button>
        <div class="long-content" data-long-content hidden data-bible-autolink>
          <longPage.Content />
          {showLongAuthor ? (
            <p class="long-author">
              By <a href={`/authors/${longAuthor!.id}`}>{longAuthor!.name}</a>
            </p>
          ) : null}
        </div>
      </div>
    ) : null}

    {relatedQuestions.length ? (
      <section class="related-questions">
        <h2>Related questions</h2>
        <ul class="question-list">
          {relatedQuestions.map((entry) => (
            <li>
              <a class="question-card card-panel" href={`/questions/${entry.slug}`}>
                {typeof entry.id === "number" ? (
                  <span class="question-id">#{entry.id}</span>
                ) : null}
                <span class="question-title">{entry.title}</span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    ) : null}
  </article>

  {showAuthorCard ? (
    <div class="resource-card card-panel question-author-card">
      <h2>{author!.name}</h2>
      {author!.bio ? <p class="resource-bio">{author!.bio}</p> : null}

      <div class="resource-actions">
        {typeof author!.count === "number" && author!.count > 0 ? (
          <a class="resource-link" href={`/authors/${author!.id}`}>
            View Answers ({author!.count})
          </a>
        ) : null}
        {author!.url ? (
          <a
            class="resource-link"
            href={author!.url}
            target="_blank"
            rel="noopener noreferrer"
          >
            Visit website
          </a>
        ) : null}
      </div>
    </div>
  ) : null}

  {questionCategories.length ? (
    <div class="category-meta category-footer">
      <a class="category-chip" href="/categories">Categories</a>
      <ul class="category-list">
        {questionCategories.map((category) => (
          <li>
            <a class="category-chip" href={`/categories/${category.id}`}>{category.name}</a>
          </li>
        ))}
      </ul>
    </div>
  ) : (
    <p class="category-placeholder category-footer">Uncategorized</p>
  )}

  <BibleReferencesScript />

  {longPage ? (
    <script type="module" is:inline>
      const scrollWithOffset = (target) => {
        const header = document.querySelector(".navbar");
        const headerHeight = header ? header.getBoundingClientRect().height : 0;
        const targetTop = window.scrollY + target.getBoundingClientRect().top - headerHeight - 16;

        window.scrollTo({
          top: Math.max(targetTop, 0),
          behavior: "smooth",
        });
      };

      document.querySelectorAll("[data-long-explanation]").forEach((section) => {
        const button = section.querySelector("[data-long-toggle]");
        const content = section.querySelector("[data-long-content]");
        if (!button || !content) {
          return;
        }

        const expandedText = {
          true: "Hide the long explanation",
          false: "Read the long explanation",
        };

        button.addEventListener("click", () => {
          const isExpanded = button.getAttribute("aria-expanded") === "true";
          const nextExpanded = !isExpanded;

          button.setAttribute("aria-expanded", String(nextExpanded));
          button.textContent = expandedText[String(nextExpanded)];

          if (nextExpanded) {
            content.hidden = false;
            requestAnimationFrame(() => {
              scrollWithOffset(content);
            });
          } else {
            content.hidden = true;
          }
        });
      });
    </script>
  ) : null}

  <script
    is:inline
    data-search-input-id={`question-search-${questionSlug}`}
  >
    {`
      (function () {
        const script = document.currentScript;
        const targetId = script?.dataset.searchInputId;
        if (!targetId) {
          return;
        }

        document.addEventListener("keydown", (event) => {
          if (event.defaultPrevented) {
            return;
          }
          if (event.key !== "/" || event.altKey || event.ctrlKey || event.metaKey) {
            return;
          }
          const activeElement = document.activeElement;
          if (activeElement && (activeElement.tagName === "INPUT" || activeElement.tagName === "TEXTAREA" || activeElement.isContentEditable)) {
            return;
          }
          const searchInput = document.getElementById(targetId);
          if (!searchInput) {
            return;
          }
          event.preventDefault();
          searchInput.focus({ preventScroll: false });
          searchInput.select();
        });
      })();
    `}
  </script>

  <style>
    .question-top-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
      justify-content: space-between;
      flex-wrap: nowrap;
      margin-bottom: 1rem;
      width: 100%;
    }

    .question-top-link {
      padding: 0.5rem 1rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #f5f5f5;
      text-decoration: none;
      font-weight: 600;
      min-width: 90px;
      text-align: center;
    }

    .question-top-link:hover {
      border-color: #f5f5f5;
    }

    .question-top-link.placeholder {
      visibility: hidden;
    }

    .question-top-search {
      flex: 0 1 360px;
      min-width: 240px;
      display: flex;
      justify-content: center;
    }

    .question-top-search .inline-search-box {
      width: 100%;
      max-width: 360px;
      padding: 0;
    }

    .question-top-link.random-link {
      min-width: auto;
    }

    @media (max-width: 640px) {
      .question-top-nav {
        flex-wrap: wrap;
        justify-content: center;
      }

      .question-top-search {
        display: none;
      }
    }

    .long-explanation {
      margin-top: 1.5rem;
    }

    .long-toggle {
      width: 100%;
      padding: 1.25rem;
      font-size: 1.25rem;
      border-radius: 1rem;
      border: 1px solid rgba(99, 179, 237, 0.4);
      background: var(--long-toggle-bg, rgba(99, 179, 237, 0.18));
      color: #f5f5f5;
      cursor: pointer;
      font-weight: 600;
      text-align: left;
      transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
    }

    .long-toggle:hover,
    .long-toggle:focus-visible {
      background: var(--long-toggle-bg-hover, rgba(99, 179, 237, 0.28));
      border-color: rgba(99, 179, 237, 0.7);
      transform: translateY(-1px);
      outline: none;
    }

    .long-content {
      margin-top: 1rem;
      padding: 1.25rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.03);
    }
  </style>
</Main>
